
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Last Layer</title>
  <style>
    body { background: #111; color: #eee; font-family: sans-serif; text-align: center; margin: 0; padding: 0; }
    #scene { width: 90%; max-width: 240px; margin: 10px auto; display: block; }
    .log { background: #222; padding: 10px; margin: 10px auto; border-radius: 8px; max-width: 90%; }
    .btn { margin: 4px; padding: 8px 14px; font-size: 14px; border: none; background-color: #444; color: #fff; border-radius: 4px; }
    .btn:hover { background-color: #666; }
    .item-icon { width: 20px; height: 20px; vertical-align: middle; margin-right: 6px; }
  </style>
</head>
<body>
  <h1>Last Layer</h1>
  <div id="status">HP: 20 / MP: 10 | EXP: 0</div>
  <div id="location">現在地: 0m</div>
  <img id="scene" src="safe_zone_background.png" alt="scene" />
  <div id="log" class="log">冒険を始めよう。</div>
  <div>
    <button class="btn" onclick="step()">進む</button>
    <button class="btn" onclick="goBack()">戻る</button>
    <button class="btn" onclick="attack()">攻撃</button>
    <button class="btn" onclick="showItems()">アイテム</button>
    <button class="btn" onclick="showSkills()">スキル</button>
  </div>

  <script>
    const enemies = [
      { name: "影", hp: 8, atk: 4, img: "enemy.png" },
      { name: "野盗", hp: 14, atk: 6, img: "bandit.png", drop: { item: "ロングソード", chance: 0.1 } },
      { name: "ゾンビ", hp: 18, atk: 4, img: "zombie.png" },
      { name: "獣人の野盗", hp: 16, atk: 5, img: "beastman.png", drop: { item: "ポーション", chance: 0.4 } },
      { name: "黒鉄の鎧", hp: 25, atk: 7, img: "armor_enemy_midboss.png", boss: true, appearAt: 600, drop: { item: "鉄の盾", chance: 1.0 } },
      { name: "堕ちた王", hp: 70, atk: 12, img: "enemy_fallen_king.png", boss: true, appearAt: 1000 }
    ];

    const weapons = {
      "ショートソード": { atk: 5, slot: "片手", icon: "sword.png" },
      "ロングソード": { atk: 7, slot: "片手", icon: "item_sword_longsword_final_updated.png" },
      "鉄の盾": { def: 4, slot: "片手", icon: "iron_shield.png" },
      "バスタードソード": { atk: 12, slot: "両手", icon: "bastard_sword.png" }
    };

    const state = {
      hp: 20, mp: 10, exp: 0, level: 1, nextExp: 20,
      position: 0, enemy: null, log: [],
      inventory: ["ショートソード", "ポーション"],
      equipped: { right: "ショートソード", left: null },
      bossesDefeated: []
    };

    function log(msg) {
      state.log.push(msg);
      if (state.log.length > 5) state.log.shift();
      document.getElementById("log").innerHTML = state.log.join("<br>");
    }

    function updateUI() {
      document.getElementById("status").textContent = `HP: ${state.hp} / MP: ${state.mp} | EXP: ${state.exp}/${state.nextExp}`;
      document.getElementById("location").textContent = `現在地: ${state.position}m`;
    }

    function step() {
      state.position += 50;
      updateUI();
      if (state.position === 0) {
        document.getElementById("scene").src = "safe_zone_background.png";
        state.hp = 20; state.mp = 10;
        log("街に戻った。HPとMPが回復！");
        return;
      }

      if (Math.random() < 0.15) {
        document.getElementById("scene").src = "fountain_dark_dungeon.png";
        state.hp = 20; state.mp = 10;
        log("泉を見つけた。HPとMPが回復！");
        return;
      }

      const boss = enemies.find(e => e.boss && e.appearAt === state.position && !state.bossesDefeated.includes(e.name));
      if (boss) return startBattle(boss);

      if (Math.random() < 0.5) {
        const enemy = enemies[Math.floor(Math.random() * 4)];
        return startBattle(enemy);
      }

      document.getElementById("scene").src = "fork.png";
      log("通路を進んだ……");
    }

    function goBack() {
      state.position = Math.max(0, state.position - 50);
      updateUI();
      if (state.position === 0) {
        state.hp = 20; state.mp = 10;
        document.getElementById("scene").src = "safe_zone_background.png";
        log("街に戻って休憩した！");
      } else {
        document.getElementById("scene").src = "fork.png";
        log("通路を戻った……");
      }
    }

    function startBattle(enemy) {
      state.enemy = Object.assign({}, enemy);
      document.getElementById("scene").src = enemy.img;
      log(`${enemy.name} が現れた！`);
    }

    function attack() {
      if (!state.enemy) return log("敵がいない！");
      const base = 5 + (weapons[state.equipped.right]?.atk || 0) + (weapons[state.equipped.left]?.atk || 0);
      const dmg = base;
      state.enemy.hp -= dmg;
      log(`敵に ${dmg} ダメージを与えた！`);
      if (state.enemy.hp <= 0) {
        log(`${state.enemy.name} を倒した！`);
        state.exp += 10;
        if (state.enemy.boss) state.bossesDefeated.push(state.enemy.name);
        if (state.enemy.drop && Math.random() < state.enemy.drop.chance) {
          state.inventory.push(state.enemy.drop.item);
          log(`${state.enemy.drop.item} を手に入れた！`);
        }
        if (state.exp >= state.nextExp) {
          state.level++; state.exp = 0; state.nextExp += 10;
          log(`レベルアップ！レベル${state.level}！`);
        }
        state.enemy = null;
        document.getElementById("scene").src = "fork.png";
      } else {
        const dmg = state.enemy.atk;
        state.hp -= dmg;
        log(`${state.enemy.name} の攻撃！${dmg} ダメージを受けた！`);
        if (state.hp <= 0) {
          log("あなたは倒れた……ゲームオーバー");
        }
      }
      updateUI();
    }

    function showItems() {
      if (state.inventory.length === 0) return log("アイテムがない");
      log("アイテム:");
      state.inventory.forEach(i => {
        const icon = weapons[i]?.icon || "potion.png";
        log(`<img class="item-icon" src="${icon}">${i}`);
      });
    }

    function showSkills() {
      log("スキル: ファイアボール（10MP）, ヒール（8MP）※未実装");
    }

    window.onload = updateUI;
  </script>
</body>
</html>
