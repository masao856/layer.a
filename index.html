
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Last Layer</title>
  <style>
    body {
      margin: 0;
      font-family: 'Georgia', serif;
      background-color: #111;
      color: #eee;
      text-align: center;
    }
    img {
      max-width: 90vw;
      height: auto;
    }
    .btn {
      margin: 8px;
      padding: 12px 20px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
    }
    .btn:disabled {
      opacity: 0.4;
    }
    .log, .inventory, .skills {
      background: rgba(255,255,255,0.05);
      padding: 10px;
      margin: 10px auto;
      max-width: 600px;
      border-radius: 8px;
    }
    .image-row {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 15px;
      flex-wrap: wrap;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div id="game">
    <img id="scene" src="fork.png" alt="通路">
    <div class="log" id="log">前方に分かれ道がある。どちらに進む？</div>
    <button class="btn" onclick="startBattle()">左に進む</button>
    <button class="btn" onclick="startBattle()">右に進む</button>
  </div>

  <script>
    let state = {
      battle: 0,
      playerHP: 30,
      enemyHP: 10,
      sword: "short",
      inventory: [],
      usedSkills: { heal: false, fire: false },
      inBattle: false
    };

    const enemies = [
      { name: "影", img: "enemy.png", hp: 10, drop: "ロングソード" },
      { name: "黒鉄の鎧", img: "armor_enemy_midboss_final.png", hp: 14, drop: "ポーション" },
      { name: "堕ちた王", img: "enemy_fallen_king_boss.png", hp: 20, drop: null }
    ];

    function startBattle() {
      state.inBattle = true;
      const e = enemies[state.battle];
      state.enemyHP = e.hp;
      document.getElementById("game").innerHTML = `
        <div class="image-row">
          <div><img src="character.png" style="max-height:100px;"><div>あなた</div></div>
          <div><img src="${e.img}" style="max-height:200px;"><div>${e.name}</div></div>
        </div>
        <div class="log" id="log">${e.name} が現れた！</div>
        <div class="log" id="status">HP: ${state.playerHP} / 敵HP: ${state.enemyHP}</div>
        <button class="btn" onclick="attack()">攻撃</button>
        <button class="btn" onclick="showSkills()">スキル</button>
        <button class="btn" onclick="showItems()">アイテム</button>
      `;
    }

    function updateStatus() {
      document.getElementById("status").textContent = `HP: ${state.playerHP} / 敵HP: ${state.enemyHP}`;
    }

    function attack() {
      if (!state.inBattle) return;
      const dmg = state.sword === "long" ? 7 : 4;
      state.enemyHP -= dmg;
      log(`あなたの攻撃！ ${dmg}ダメージ`);
      checkVictory();
    }

    function showItems() {
      const items = state.inventory.map(i => {
        if (i === "ポーション") return `<button class="btn" onclick="useItem('potion')">ポーション</button>`;
        if (i === "ショートソード") return `<button class="btn" onclick="equip('short')">ショートソード</button>`;
        if (i === "ロングソード") return `<button class="btn" onclick="equip('long')">ロングソード</button>`;
        return '';
      }).join(" ");
      log(`<div class="inventory">${items || "アイテムなし"}</div>`);
    }

    function showSkills() {
      const skills = `
        <button class="btn" ${state.usedSkills.fire ? 'disabled' : ''} onclick="useSkill('fire')">攻撃魔法</button>
        <button class="btn" ${state.usedSkills.heal ? 'disabled' : ''} onclick="useSkill('heal')">回復魔法</button>
      `;
      log(`<div class="skills">${skills}</div>`);
    }

    function useItem(type) {
      if (type === "potion" && state.inventory.includes("ポーション")) {
        state.playerHP += 10;
        state.inventory.splice(state.inventory.indexOf("ポーション"), 1);
        log("ポーションを使用し、HPを10回復！");
        enemyTurn();
      }
      updateStatus();
    }

    function equip(sword) {
      state.sword = sword;
      log(`${sword === "long" ? "ロングソード" : "ショートソード"}を装備した`);
    }

    function useSkill(skill) {
      if (state.usedSkills[skill]) return;
      if (skill === "fire") {
        state.enemyHP -= 6;
        log("攻撃魔法を放った！ 6ダメージ");
      } else if (skill === "heal") {
        state.playerHP += 8;
        log("回復魔法を使った！ HPが8回復");
      }
      state.usedSkills[skill] = true;
      updateStatus();
      checkVictory();
    }

    function enemyTurn() {
      if (!state.inBattle) return;
      state.playerHP -= 5;
      log("敵の攻撃！ あなたは5ダメージを受けた");
      if (state.playerHP <= 0) {
        state.playerHP = 0;
        updateStatus();
        endGame(false);
      } else {
        updateStatus();
      }
    }

    function checkVictory() {
      if (state.enemyHP <= 0) {
        state.enemyHP = 0;
        updateStatus();
        const e = enemies[state.battle];
        if (e.drop) state.inventory.push(e.drop);
        state.inBattle = false;
        const after = e.drop
          ? `${e.name} を倒した！ ${e.drop}を手に入れた！<br><button class="btn" onclick="nextBattle()">次へ</button>`
          : `${e.name} を倒した！<br><button class="btn" onclick="endGame(true)">クリア！</button>`;
        log(after);
      } else {
        enemyTurn();
      }
    }

    function nextBattle() {
      state.battle++;
      state.usedSkills = { heal: false, fire: false };
      startBattle();
    }

    function endGame(win) {
      document.getElementById("game").innerHTML = win
        ? "<h2>すべての敵を倒した……</h2><p>深層への道が開かれる。</p>"
        : "<h2>あなたは敗北した……</h2><p>冒険はここで終わる。</p>";
    }

    function log(msg) {
      document.getElementById("log").innerHTML = msg;
    }
  </script>
</body>
</html>
