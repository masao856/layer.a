
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Last Layer - 修正版</title>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: "Georgia", serif;
      text-align: center;
      margin: 0;
    }
    img {
      max-width: 95vw;
      height: auto;
    }
    .btn {
      margin: 10px;
      padding: 14px 24px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 1.2rem;
    }
    .btn:disabled {
      opacity: 0.5;
    }
    .log, .inventory, .skills {
      background: rgba(255, 255, 255, 0.05);
      padding: 16px;
      margin: 12px auto;
      max-width: 700px;
      border-radius: 10px;
      font-size: 1.1rem;
    }
  </style>
</head>
<body>
<div id="game">
  <img id="scene" src="fork.png" alt="通路" />
  <div class="log" id="log">ロード完了。JavaScriptが統合されています。</div>
  <button class="btn" onclick="stepForward()">進む</button>
  <button class="btn" onclick="showItems()">アイテム</button>
  <button class="btn" onclick="showSkills()">スキル</button>
</div>

<script>
const state = {
  hp: 20,
  mp: 10,
  attack: 5,
  magic: 3,
  defense: 3,
  magicDefense: 2,
  speed: 5,
  level: 1,
  exp: 0,
  nextExp: 20,
  inventory: ["ショートソード"],
  equipped: {
    right: "ショートソード",
    left: null
  },
  encounterChance: 0.5,
  battle: false,
  enemy: null,
  defeated: [],
  awaitingInput: false
};

const weapons = {
  "ショートソード": { atk: 5, slot: "片手", icon: "sword.png" }
};

const enemies = [
  {
    name: "影",
    hp: 12,
    attack: 4,
    defense: 1,
    speed: 4,
    img: "shadow.png",
    drop: null
  }
];

function log(msg) {
  const logBox = document.getElementById("log");
  if (logBox) logBox.innerHTML = msg;
}

function stepForward() {
  const roll = Math.random();
  if (roll < state.encounterChance) {
    const enemy = enemies[Math.floor(Math.random() * enemies.length)];
    startBattle(enemy);
  } else {
    log("あなたは通路を歩いている……");
  }
}

function startBattle(enemy) {
  state.battle = true;
  state.enemy = { ...enemy };
  document.getElementById("scene").src = enemy.img;
  updateUIForBattle();
}

function attackEnemy() {
  if (!state.battle || state.awaitingInput) return;

  const dmg = Math.max(1, state.attack - (state.enemy.defense || 0));
  state.enemy.hp -= dmg;
  log(`あなたの攻撃！${state.enemy.name} に ${dmg} ダメージ！`);

  if (state.enemy.hp <= 0) {
    log(`${state.enemy.name} を倒した！`);
    state.battle = false;
    showPostBattleOptions();
  } else {
    setTimeout(enemyAttack, 1000);
  }
}

function enemyAttack() {
  const dmg = Math.max(1, state.enemy.attack - state.defense);
  state.hp -= dmg;
  log(`${state.enemy.name} の攻撃！あなたは ${dmg} ダメージを受けた！`);

  if (state.hp <= 0) {
    log("あなたは力尽きた……");
    disableAll();
  } else {
    setTimeout(updateUIForBattle, 1000);
  }
}

function updateUIForBattle() {
  document.getElementById("game").innerHTML = `
    <img id="scene" src="${state.enemy.img}" />
    <div class="log" id="log">${state.enemy.name} が現れた！<br>あなたのHP: ${state.hp} / 敵のHP: ${state.enemy.hp}</div>
    <button class="btn" onclick="attackEnemy()">攻撃</button>
    <button class="btn" onclick="showItems()">アイテム</button>
    <button class="btn" onclick="showSkills()">スキル</button>
  `;
}

function showItems() {
  log("アイテム機能は未実装です。");
}

function showSkills() {
  log("スキル機能は未実装です。");
}

function showPostBattleOptions() {
  document.getElementById("game").innerHTML = `
    <img id="scene" src="fork.png" alt="通路" />
    <div class="log" id="log">通路を進みます。</div>
    <button class="btn" onclick="stepForward()">進む</button>
    <button class="btn" onclick="showItems()">アイテム</button>
    <button class="btn" onclick="showSkills()">スキル</button>
  `;
}

function disableAll() {
  document.getElementById("game").innerHTML = "<h1>GAME OVER</h1>";
}
</script>
</body>
</html>
