<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Last Layer</title>
  <style>
    body { background: #111; color: #eee; font-family: 'Georgia', serif; text-align: center; margin: 0; }
    #scene { width: 100%; max-width: 180px; height: auto; display: block; margin: 0 auto; }
    .btn { margin: 4px; padding: 6px 14px; background: #333; color: #fff; border: none; border-radius: 5px; font-size: 0.9rem; }
    .log, .inventory, .skills {
      background: rgba(255, 255, 255, 0.08);
      padding: 8px;
      margin: 6px auto;
      max-width: 550px;
      border-radius: 6px;
      font-size: 0.95rem;
    }
    #status, #distance { margin: 6px; font-size: 0.95rem; color: #aaa; }
    .item-icon { height: 18px; vertical-align: middle; margin-right: 6px; }
  </style>
</head>
<body>
  <h1>Last Layer</h1>
  <div id="status">HP: 20 / MP: 10 | EXP: 0 / 20</div>
  <div id="distance">現在地：0m</div>
  <img id="scene" src="fork.png" alt="scene" />
  <div class="log" id="log">冒険を始めよう。</div>
  <div>
    <button class="btn" onclick="stepForward()">進む</button>
    <button class="btn" onclick="stepBackward()">戻る</button>
    <button class="btn" onclick="showItems()">アイテム</button>
    <button class="btn" onclick="showSkills()">スキル</button>
    <button class="btn" onclick="attackEnemy()">攻撃</button>
  </div>
  <script>
    const state = {
      hp: 20, mp: 10, attack: 5, magic: 3, defense: 3,
      level: 1, exp: 0, nextExp: 20,
      inventory: ["ショートソード", "ポーション"],
      skills: ["ファイアボール", "ヒール"],
      distance: 0, battle: false, enemy: null,
      defeatedBosses: []
    };

    const enemies = {
      common: [
        { name: "影", hp: 12, attack: 4, img: "enemy.png", exp: 5 },
        { name: "野盗", hp: 14, attack: 5, img: "bandit.png", exp: 7, drop: { item: "ロングソード", chance: 0.1 } },
        { name: "ゾンビ", hp: 16, attack: 3, img: "zombie.png", exp: 6 },
        { name: "獣人の野盗", hp: 18, attack: 6, img: "beastman.png", exp: 8, drop: { item: "ポーション", chance: 0.4 } }
      ],
      midboss: { name: "黒鉄の鎧", hp: 25, attack: 7, img: "armor_enemy_midboss_final.png", exp: 20, drop: { item: "鉄の盾", chance: 1.0 } },
      boss: { name: "堕ちた王", hp: 70, attack: 16, magic: 8, img: "enemy_fallen_king_boss.png", exp: 50 }
    };

    const icons = {
      "ショートソード": "sword.png",
      "ロングソード": "item_sword_longsword_final_updated.png",
      "鉄の盾": "iron_shield.png",
      "ポーション": "item_potion_basic_final.png"
    };

    function updateStatus() {
      document.getElementById("status").innerText =
        `HP: ${state.hp} / MP: ${state.mp} | EXP: ${state.exp} / ${state.nextExp}`;
    }

    function updateDistance() {
      document.getElementById("distance").innerText = `現在地：${state.distance}m`;
    }

    function log(msg) {
      document.getElementById("log").innerHTML = msg;
      updateStatus();
    }

    function stepForward() {
      if (state.battle) return;
      state.distance += 50;
      updateDistance();

      if (state.distance === 600 && !state.defeatedBosses.includes("黒鉄の鎧")) {
        startBattle(enemies.midboss);
        return;
      } else if (state.distance === 1000 && !state.defeatedBosses.includes("堕ちた王")) {
        startBattle(enemies.boss);
        return;
      }

      if (Math.random() < 0.02) {
        state.hp = 20 + state.level * 2;
        state.mp = 10 + state.level;
        document.getElementById("scene").src = "spring.png";
        log("不思議な泉を見つけた…HPとMPが全回復した！");
        return;
      }

      const encounter = Math.random();
      if (encounter < 0.5) {
        const pool = enemies.common;
        const enemy = JSON.parse(JSON.stringify(pool[Math.floor(Math.random() * pool.length)]));
        startBattle(enemy);
      } else {
        document.getElementById("scene").src = "fork.png";
        log("通路を進んだ……");
      }
    }

    function stepBackward() {
      if (state.battle) return;
      if (state.distance <= 0) {
        document.getElementById("scene").src = "town.png";
        state.hp = 20 + state.level * 2;
        state.mp = 10 + state.level;
        log("街に戻って休憩した。HPとMPが全回復！");
      } else {
        state.distance -= 50;
        updateDistance();
        document.getElementById("scene").src = "fork.png";
        log("一歩後退した……");
      }
    }

    function startBattle(enemy) {
      state.enemy = enemy;
      state.battle = true;
      document.getElementById("scene").src = enemy.img;
      log(`${enemy.name} が現れた！`);
    }

    function attackEnemy() {
      if (!state.battle || !state.enemy) return;
      const damage = state.attack;
      state.enemy.hp -= damage;
      log(`あなたの攻撃！${state.enemy.name} に ${damage} ダメージ！`);

      if (state.enemy.hp <= 0) {
        log(`${state.enemy.name} を倒した！`);
        state.exp += state.enemy.exp || 0;
        levelUp();
        tryDrop(state.enemy);
        if (["黒鉄の鎧", "堕ちた王"].includes(state.enemy.name)) {
          state.defeatedBosses.push(state.enemy.name);
        }
        state.battle = false;
        document.getElementById("scene").src = "fork.png";
      } else {
        setTimeout(enemyAttack, 600);
      }
    }

    function enemyAttack() {
      const damage = state.enemy.attack;
      state.hp -= damage;
      log(`${state.enemy.name} の攻撃！あなたは ${damage} ダメージを受けた！`);
      if (state.hp <= 0) {
        log("あなたは倒れた……GAME OVER");
        state.battle = false;
      }
    }

    function tryDrop(enemy) {
      if (enemy.drop && Math.random() < enemy.drop.chance) {
        state.inventory.push(enemy.drop.item);
        log(`${enemy.drop.item} を手に入れた！`);
      }
    }

    function levelUp() {
      while (state.exp >= state.nextExp) {
        state.exp -= state.nextExp;
        state.level++;
        state.nextExp = Math.floor(state.nextExp * 1.5);
        log(`レベルアップ！現在レベル: ${state.level}`);
        state.hp = 20 + state.level * 2;
        state.mp = 10 + state.level;
      }
    }

    function showItems() {
      let output = '<div class="inventory">アイテム:<br>';
      for (let item of state.inventory) {
        const icon = icons[item] || "unknown.png";
        output += `<button class="btn" onclick="useItem('${item}')"><img src="${icon}" class="item-icon">${item}</button> `;
      }
      output += '</div>';
      log(output);
    }

    function useItem(item) {
      if (item === "ポーション") {
        state.hp = 20 + state.level * 2;
        state.inventory = state.inventory.filter(i => i !== item);
        log("ポーションでHPを全回復！");
      } else {
        log(`${item} は使えません。`);
      }
    }

    function showSkills() {
      let output = '<div class="skills">スキル:<br>';
      for (let skill of state.skills) {
        output += `<button class="btn" onclick="useSkill('${skill}')">${skill}</button> `;
      }
      output += '</div>';
      log(output);
    }

    function useSkill(skill) {
      if (skill === "ヒール" && state.mp >= 3) {
        state.hp = 20 + state.level * 2;
        state.mp -= 3;
        log("ヒールでHPを回復！");
      } else if (skill === "ファイアボール" && state.mp >= 5 && state.enemy) {
        const damage = state.magic + state.level;
        state.enemy.hp -= damage;
        state.mp -= 5;
        log(`ファイアボールで ${state.enemy.name} に ${damage} ダメージ！`);
        if (state.enemy.hp <= 0) {
          log(`${state.enemy.name} を倒した！`);
          state.exp += state.enemy.exp || 0;
          levelUp();
          tryDrop(state.enemy);
          if (["黒鉄の鎧", "堕ちた王"].includes(state.enemy.name)) {
            state.defeatedBosses.push(state.enemy.name);
          }
          state.battle = false;
          document.getElementById("scene").src = "fork.png";
        } else {
          setTimeout(enemyAttack, 600);
        }
      } else {
        log("条件を満たしていないかMPが不足しています。");
      }
    }
  </script>
</body>
</html>