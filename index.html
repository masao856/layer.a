
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Last Layer</title>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: "Georgia", serif;
      text-align: center;
      margin: 0;
    }
    img {
      max-width: 95vw;
      height: auto;
    }
    .btn {
      margin: 10px;
      padding: 14px 24px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 1.2rem;
    }
    .btn:disabled {
      opacity: 0.5;
    }
    .log, .inventory, .skills {
      background: rgba(255, 255, 255, 0.05);
      padding: 16px;
      margin: 12px auto;
      max-width: 700px;
      border-radius: 10px;
      font-size: 1.1rem;
    }
    .image-row {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 20px;
      flex-wrap: wrap;
    }
    .item-icon {
      height: 28px;
      width: 28px;
      vertical-align: middle;
      margin-right: 10px;
    }
    .shake {
      animation: shake 0.2s;
    }
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
      100% { transform: translateX(0); }
    }
    .flash {
      filter: brightness(3);
      transition: filter 0.1s ease;
    }
  </style>
</head>
<body>
<div id="game">
  <img id="scene" src="fork.png" alt="通路" />
  <div class="log" id="log">ロード完了。JavaScriptが統合されています。</div>
  <button class="btn" onclick="stepForward()">進む</button>
  <button class="btn" onclick="showItems()">アイテム</button>
  <button class="btn" onclick="showSkills()">スキル</button>
</div>

<script>
const state = {
  hp: 20,
  mp: 10,
  attack: 5,
  magic: 3,
  defense: 3,
  magicDefense: 2,
  speed: 5,
  level: 1,
  exp: 0,
  nextExp: 20,
  inventory: ["ショートソード"],
  equipped: {
    right: "ショートソード",
    left: null
  },
  encounterChance: 0.4,
  battle: false,
  enemy: null,
  defeated: [],
  awaitingInput: false
};

const weapons = {
  "ショートソード": { atk: 5, slot: "片手", icon: "sword.png" },
  "ロングソード": { atk: 7, slot: "片手", icon: "item_sword_longsword_final_updated.png" },
  "鉄の盾": { def: 4, slot: "片手", icon: "iron_shield.png" },
  "バスタードソード": { atk: 12, slot: "両手", icon: "bastard_sword.png" }
};

const enemies = [
  {
    name: "野盗",
    hp: 14,
    attack: 6,
    defense: 2,
    speed: 6,
    img: "bandit.png",
    drop: { item: "ロングソード", chance: 0.1 }
  },
  {
    name: "ゾンビ",
    hp: 18,
    attack: 4,
    defense: 4,
    speed: 2,
    img: "zombie.png",
    drop: null
  },
  {
    name: "獣人の野盗",
    hp: 16,
    attack: 5,
    defense: 3,
    speed: 7,
    img: "beastman.png",
    drop: { item: "ポーション", chance: 0.4 }
  },
  {
    name: "黒鉄の鎧",
    hp: 25,
    attack: 7,
    defense: 6,
    speed: 3,
    img: "armor_enemy_midboss_final.png",
    drop: { item: "鉄の盾", chance: 1.0 }
  },
  {
    name: "堕ちた王",
    hp: 35,
    attack: 8,
    magic: 4,
    defense: 4,
    magicDefense: 4,
    speed: 4,
    img: "enemy_fallen_king_boss.png",
    drop: null
  }
];

function stepForward() {
  const roll = Math.random();
  if (roll < state.encounterChance) {
    const pool = enemies.filter(e => !state.defeated.includes(e.name));
    const enemy = pool[Math.floor(Math.random() * pool.length)];
    startBattle(enemy);
  } else {
    log("あなたは通路を歩いている……");
  }
}

function startBattle(enemy) {
  state.battle = true;
  state.enemy = Object.assign({}, enemy);
  document.getElementById("scene").src = enemy.img;
  log(`${enemy.name} が現れた！`);
  updateUIForBattle();
}

function attackEnemy() {
  if (!state.battle || state.awaitingInput) return;

  const weaponRight = weapons[state.equipped.right] || {};
  const weaponLeft = weapons[state.equipped.left] || {};
  let totalAtk = state.attack + (weaponRight.atk || 0) + (weaponLeft.atk || 0);
  state.enemy.hp -= totalAtk;

  showEffect("scene");

  if (state.enemy.hp <= 0) {
    log(`${state.enemy.name} を倒した！`);
    gainExp(10);
    tryDrop(state.enemy);
    state.defeated.push(state.enemy.name);
    state.battle = false;
    showPostBattleOptions();
  } else {
    setTimeout(enemyAttack, 500);
  }
}

function enemyAttack() {
  const dmg = Math.max(1, state.enemy.attack - state.defense);
  state.hp -= dmg;
  log(`敵の攻撃！あなたは ${dmg} ダメージを受けた`);

  if (state.hp <= 0) {
    log("あなたは力尽きた……");
    disableAll();
  }
}

function gainExp(amount) {
  state.exp += amount;
  if (state.exp >= state.nextExp) {
    state.exp -= state.nextExp;
    state.nextExp = Math.floor(state.nextExp * 1.5);
    state.level++;
    log(`レベルアップ！ステータスを選んでください`);
    showStatChoices();
  }
}

function showStatChoices() {
  const stats = ["HP", "MP", "攻撃力", "魔法攻撃力", "防御力", "魔法防御力", "素早さ"];
  const buttons = stats.map(stat => `<button class="btn" onclick="chooseStat('${stat}')">${stat}</button>`).join(" ");
  log(buttons);
  state.awaitingInput = true;
}

function chooseStat(stat) {
  switch(stat) {
    case "HP": state.hp += 5; break;
    case "MP": state.mp += 3; break;
    case "攻撃力": state.attack += 1; break;
    case "魔法攻撃力": state.magic += 1; break;
    case "防御力": state.defense += 1; break;
    case "魔法防御力": state.magicDefense += 1; break;
    case "素早さ": state.speed += 1; break;
  }
  log(`ステータス「${stat}」が成長した！`);
  state.awaitingInput = false;
}

function tryDrop(enemy) {
  if (enemy.drop && Math.random() < enemy.drop.chance) {
    state.inventory.push(enemy.drop.item);
    log(`${enemy.drop.item} を手に入れた！`);
  }
}

function showItems() {
  if (state.inventory.length === 0) {
    log("アイテムなし");
    return;
  }
  const buttons = state.inventory.map(i => {
    const icon = weapons[i]?.icon || "potion.png";
    return `<button class="btn" onclick="equipItem('${i}')"><img class="item-icon" src="${icon}">${i}</button>`;
  }).join(" ");
  log(`<div class="inventory">${buttons}</div>`);
}

function equipItem(item) {
  const type = weapons[item]?.slot;
  if (type === "両手") {
    state.equipped.right = item;
    state.equipped.left = null;
  } else {
    if (!state.equipped.right) {
      state.equipped.right = item;
    } else if (!state.equipped.left) {
      state.equipped.left = item;
    } else {
      state.equipped.right = item;
    }
  }
  log(`${item} を装備した`);
}

function log(msg) {
  const logBox = document.getElementById("log");
  if (logBox) logBox.innerHTML = msg;
}

function showPostBattleOptions() {
  document.getElementById("game").innerHTML = `
    <img id="scene" src="fork.png" alt="通路" />
    <div class="log" id="log">あなたは通路を歩いている……</div>
    <button class="btn" onclick="stepForward()">進む</button>
    <button class="btn" onclick="showItems()">アイテム</button>
    <button class="btn" onclick="showSkills()">スキル</button>
  `;
}

function disableAll() {
  document.getElementById("game").innerHTML += `<p>GAME OVER</p>`;
}

function showSkills() {
  log("スキルは現在未実装");
}

function updateUIForBattle() {
  document.getElementById("game").innerHTML = `
    <img id="scene" src="${state.enemy.img}" />
    <div class="log">${state.enemy.name} が現れた！</div>
    <div class="log">あなたのHP: ${state.hp} / 敵のHP: ${state.enemy.hp}</div>
    <button class="btn" onclick="attackEnemy()">攻撃</button>
    <button class="btn" onclick="showItems()">アイテム</button>
  `;
}

function showEffect(targetId) {
  const el = document.getElementById(targetId);
  el.classList.add("shake", "flash");
  setTimeout(() => el.classList.remove("shake", "flash"), 200);
}
</script>
</body>
</html>
